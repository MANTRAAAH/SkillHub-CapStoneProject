<div class="filters">
  <h3>Filtra ordini</h3>

  <div>
    <label for="status">Stato</label>
    <select id="status" [(ngModel)]="filter.status">
      <option value="">Tutti</option>
      <option value="Pending">Pending</option>
      <option value="Paid">Paid</option>
      <option value="Failed">Failed</option>
    </select>
  </div>

  <div>
    <label for="dateFrom">Data da</label>
    <input type="date" id="dateFrom" [(ngModel)]="filter.dateFrom" />
    <label for="dateTo">Data a</label>
    <input type="date" id="dateTo" [(ngModel)]="filter.dateTo" />
  </div>

  <div>
    <label for="price">Prezzo massimo</label>
    <input type="number" id="price" [(ngModel)]="filter.maxPrice" />
  </div>

  <div>
    <label for="search">Ricerca per servizio/cliente</label>
    <input type="text" id="search" [(ngModel)]="filter.searchQuery" />
  </div>

  <button class="btn btn-primary" (click)="applyFilters()">
    Applica filtri
  </button>
</div>

<!-- Tabella ordini -->
<table class="table table-striped mt-4">
  <!-- Intestazioni -->
  <thead>
    <tr>
      <th>Id Ordine</th>
      <th>Servizio</th>
      <th>Cliente</th>
      <th>Freelancer</th>
      <th>Data</th>
      <th>Stato Ordine</th>
      <th>Stato Pagamento</th>
      <th>Prezzo Totale</th>
      <th>Azioni</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let order of filteredOrders">
      <td>{{ order.orderID }}</td>
      <td>{{ order.serviceTitle }}</td>
      <td>{{ order.clientUsername }}</td>
      <td>{{ order.freelancerUsername }}</td>
      <td>{{ order.orderDate | date }}</td>
      <td>
        <!-- Mostra un badge colorato in base allo stato -->
        <span
          [ngClass]="{
            'badge bg-success': order.status === 'Completed',
            'badge bg-warning': order.status === 'Pending'
          }"
        >
          {{ order.status }}
        </span>
      </td>
      <td>{{ order.paymentStatus }}</td>
      <td>{{ order.totalPrice | currency }}</td>
      <!-- Condizione per applicare la classe bg-success se ci sono file -->
      <td [ngClass]="{ 'bg-success': order.files && order.files.length > 0 }">
        <!-- Mostra l'opzione di caricamento solo se l'utente è un freelancer e non ci sono file -->
        <div *ngIf="isFreelancer && (!order.files || order.files.length === 0)">
          <input type="file" (change)="onFileSelected($event)" multiple />
          <button
            class="btn btn-primary btn-sm"
            (click)="uploadFiles(order.orderID)"
          >
            Carica File
          </button>
        </div>

        <!-- Mostra i file caricati -->
        <div *ngIf="order.files && order.files.length > 0">
          <h5>File caricati:</h5>
          <ul>
            <li *ngFor="let file of order.files">
              <button
                class="btn btn-sm btn-warning"
                (click)="downloadFile(order.orderID, file.orderFileID)"
              >
                Scarica {{ file.filePath.split("/").pop() }}
              </button>
              <!-- Mostra il pulsante "Elimina" solo se l'utente è un freelancer -->
              <button
                *ngIf="isFreelancer"
                class="btn btn-sm btn-danger"
                (click)="deleteFile(order.orderID, file.orderFileID)"
              >
                Elimina
              </button>
            </li>
          </ul>
        </div>
      </td>
      <td>
        <!-- Mostra il pulsante di completamento se l'utente è un freelancer e l'ordine ha dei file -->
        <button
          *ngIf="
            isFreelancer &&
            order.files &&
            order.files.length > 0 &&
            order.status !== 'Completed'
          "
          class="btn btn-success btn-sm"
          (click)="completeOrder(order.orderID)"
        >
          Completa Ordine
        </button>
      </td>
    </tr>
  </tbody>
</table>

<!-- Mostra un messaggio se non ci sono ordini filtrati -->
<p *ngIf="filteredOrders.length === 0" class="text-center">
  Nessun ordine trovato.
</p>
